<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Polymer Dryer — Drying Log Entry</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --dark:   #0d1117;
    --panel:  #161b22;
    --border: #21262d;
    --accent: #e94560;
    --gold:   #f5a623;
    --blue:   #58a6ff;
    --green:  #3fb950;
    --red:    #f85149;
    --text:   #e6edf3;
    --muted:  #8b949e;
    --input:  #1c2128;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--dark);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    padding: 0;
  }

  /* TOPBAR */
  .topbar {
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    height: 56px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .topbar-logo {
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    white-space: nowrap;
    line-height: 1.3;
    display: flex;
    flex-direction: column;
  }
  .topbar-logo-sub {
    font-size: 0.58rem;
    color: var(--muted);
    letter-spacing: 0.12em;
  }
  .topbar-sep { width: 1px; height: 24px; background: var(--border); }
  .topbar-meta { font-size: 0.75rem; color: var(--muted); }
  .topbar-meta span { color: var(--text); }
  .topbar-right { margin-left: auto; display: flex; gap: 1rem; align-items: center; }
  .badge {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    padding: 3px 8px;
    border-radius: 3px;
    letter-spacing: 0.08em;
  }
  .badge-easa  { background: #1e3a5f; color: var(--blue); border: 1px solid #2d5a9e; }
  .badge-site  { background: #1e3030; color: var(--green); border: 1px solid #2d5a3d; }

  /* HERO */
  .hero {
    padding: 2rem 2rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
  }
  .hero h1 {
    font-family: 'Space Mono', monospace;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.02em;
    margin-bottom: 0.35rem;
  }
  .hero h1 span { color: var(--accent); }
  .hero-sub {
    font-size: 0.8rem;
    color: var(--muted);
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }
  .hero-sub span { color: var(--text); font-weight: 500; }

  /* LAYOUT */
  .page { max-width: 1100px; margin: 0 auto; padding: 2rem; }

  /* SECTION LABEL */
  .section-label {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* GRID */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
  .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; }
  .span-2 { grid-column: span 2; }

  /* CARDS */
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .card-accent { border-left: 3px solid var(--accent); }
  .card-gold   { border-left: 3px solid var(--gold); }
  .card-blue   { border-left: 3px solid var(--blue); }

  /* FORM FIELDS */
  .field { display: flex; flex-direction: column; gap: 0.35rem; }
  .field label {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .field label .req { color: var(--accent); margin-left: 2px; }

  .field input, .field select {
    background: var(--input);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    padding: 0.55rem 0.75rem;
    transition: border-color 0.15s, box-shadow 0.15s;
    width: 100%;
    appearance: none;
    -webkit-appearance: none;
  }
  .field input:focus, .field select:focus {
    outline: none;
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(88,166,255,0.12);
  }
  .field select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238b949e' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 2rem;
    cursor: pointer;
  }
  .field select option { background: #1c2128; }
  .field input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(0.6);
    cursor: pointer;
  }

  /* INLINE BAY SELECTOR */
  .bay-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
  }
  .bay-btn {
    background: var(--input);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 0.9rem;
    font-weight: 700;
    padding: 0.6rem 0;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }
  .bay-btn:hover { border-color: var(--blue); color: var(--text); }
  .bay-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    box-shadow: 0 0 12px rgba(233,69,96,0.35);
  }
  #bay-hidden { display: none; }

  /* MOISTURE INDICATOR */
  .moisture-wrap { position: relative; }
  .moisture-indicator {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--border);
    transition: background 0.3s;
  }
  #moisture-after-wrap .moisture-indicator { right: 10px; }

  /* SEQUENCE DISPLAY */
  .seq-display {
    font-family: 'Space Mono', monospace;
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
    text-align: center;
    padding: 0.5rem;
    background: rgba(233,69,96,0.08);
    border-radius: 6px;
    border: 1px solid rgba(233,69,96,0.2);
    letter-spacing: 0.05em;
  }

  /* BUTTONS */
  .btn-row { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
  .btn {
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.875rem;
    padding: 0.65rem 1.5rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.02em;
  }
  .btn-primary {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 2px 8px rgba(233,69,96,0.35);
  }
  .btn-primary:hover { background: #d63651; transform: translateY(-1px); }
  .btn-secondary {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { color: var(--text); border-color: var(--muted); }
  .btn-export {
    background: rgba(88,166,255,0.1);
    color: var(--blue);
    border: 1px solid rgba(88,166,255,0.3);
  }
  .btn-export:hover { background: rgba(88,166,255,0.2); }

  /* LOG TABLE */
  .log-wrap {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
  }
  th {
    background: #1c2128;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.7rem 0.8rem;
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
  }
  td {
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    white-space: nowrap;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.03); }
  .td-seq { font-family: 'Space Mono', monospace; color: var(--accent); font-weight: 700; }
  .td-green { background: rgba(63,185,80,0.15); color: var(--green); font-weight: 600; }
  .td-red   { background: rgba(248,81,73,0.15);  color: var(--red);   font-weight: 600; }
  .td-calc  { color: var(--blue); font-style: italic; }
  .empty-state {
    text-align: center;
    color: var(--muted);
    padding: 3rem;
    font-size: 0.85rem;
  }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--panel);
    border: 1px solid var(--green);
    border-radius: 8px;
    padding: 0.9rem 1.4rem;
    color: var(--green);
    font-weight: 600;
    font-size: 0.875rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(.34,1.56,.64,1);
    z-index: 999;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* ACTIVITY TOGGLE */
  .activity-toggle {
    display: flex;
    align-items: center;
    cursor: pointer;
  }
  .activity-toggle input[type="radio"] { display: none; }
  .activity-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.55rem 1.4rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--input);
    color: var(--muted);
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.15s;
    user-select: none;
  }
  .activity-toggle:hover .activity-label { border-color: var(--muted); color: var(--text); }
  .activity-toggle input:checked + .activity-label {
    border-color: var(--blue);
    background: rgba(88,166,255,0.1);
    color: var(--blue);
    box-shadow: 0 0 0 2px rgba(88,166,255,0.15);
  }
  #lbl-removal input:checked + .activity-label {
    border-color: var(--gold);
    background: rgba(245,166,35,0.1);
    color: var(--gold);
    box-shadow: 0 0 0 2px rgba(245,166,35,0.15);
  }
  .activity-icon { font-size: 1rem; }
  .activity-block {
    border-radius: 7px;
    border: 1px solid var(--border);
    padding: 1rem 1.25rem 0.25rem;
    margin-bottom: 1rem;
    background: rgba(255,255,255,0.02);
    animation: fadeSlide 0.2s ease;
  }
  @keyframes fadeSlide {
    from { opacity:0; transform:translateY(-6px); }
    to   { opacity:1; transform:translateY(0); }
  }

  /* DIVIDER */
  .divider { height: 1px; background: var(--border); margin: 2rem 0; }

  @media (max-width: 700px) {
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    .span-2 { grid-column: 1; }
    .bay-grid { grid-template-columns: repeat(4,1fr); }
    .page { padding: 1rem; }
    .hero { padding: 1rem; }
    .hero h1 { font-size: 1.1rem; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-logo">AM-Craft<span class="topbar-logo-sub">LV.21G.0002</span></div>
  <div class="topbar-sep"></div>
  <div class="topbar-meta">Machine: <span>Polymer Dryer</span></div>
  <div class="topbar-sep"></div>
  <div class="topbar-meta">S/N: <span>CFLA_13</span></div>
  <div class="topbar-sep"></div>
  <div class="topbar-meta">Tool Nr: <span>AM11</span></div>
  <div class="topbar-right">
    <span class="badge badge-site">Site A · Riga</span>
  </div>
</div>

<div class="hero">
  <h1>Polymer Dryer — <span>Material Drying Log</span></h1>
  <div class="hero-sub">
    Location: <span>22D Braslas Street, Riga, Latvia</span>
  </div>
</div>

<div class="page">

  <!-- FORM -->
  <div class="section-label">New Entry</div>

  <div class="card card-accent">

    <!-- Row: Seq + Material -->
    <div class="grid-4" style="margin-bottom:1rem; align-items:end;">
      <div class="field">
        <label>Seq. Nr</label>
        <div class="seq-display" id="seq-display">001</div>
      </div>
      <div class="field">
        <label>Batch / Serial Nr <span class="req">*</span></label>
        <input type="text" id="batch" placeholder="e.g. UL9085-2024-001" autocomplete="off">
      </div>
      <div class="field">
        <label>Material Type <span class="req">*</span></label>
        <select id="material">
          <option value="">— Select —</option>
          <option>Ultem 9085 CG</option>
          <option>Ultem 9085 Natural</option>
          <option>Ultem 9085 Black</option>
          <option>Ultem Support</option>
          <option>ATAR FST</option>
          <option>Vulcan TPI</option>
          <option>KRATIR rPEEK</option>
        </select>
      </div>
      <div class="field">
        <label>Amount on Spool (cm³) <span class="req">*</span></label>
        <input type="number" id="amount" placeholder="e.g. 3250" min="0" step="1">
      </div>
    </div>

    <!-- Row: Moisture Before + Bay -->
    <div class="grid-2" style="margin-bottom:1.25rem;">
      <div class="field">
        <label>Moisture % Before Installing <span class="req">*</span></label>
        <div class="moisture-wrap">
          <input type="number" id="moisture-before" placeholder="e.g. 0.045" step="0.001" min="0">
          <div class="moisture-indicator" id="ind-before"></div>
        </div>
      </div>
      <div>
        <label style="display:block; font-size:0.72rem; font-weight:600; color:var(--muted); letter-spacing:0.06em; text-transform:uppercase; margin-bottom:0.5rem;">
          Drying Bay <span class="req" style="color:var(--accent);">*</span>
        </label>
        <div class="bay-grid">
          <button class="bay-btn" onclick="selectBay(1)">1</button>
          <button class="bay-btn" onclick="selectBay(2)">2</button>
          <button class="bay-btn" onclick="selectBay(3)">3</button>
          <button class="bay-btn" onclick="selectBay(4)">4</button>
          <button class="bay-btn" onclick="selectBay(5)">5</button>
          <button class="bay-btn" onclick="selectBay(6)">6</button>
          <button class="bay-btn" onclick="selectBay(7)">7</button>
          <button class="bay-btn" onclick="selectBay(8)">8</button>
        </div>
        <input type="hidden" id="bay-hidden">
      </div>
    </div>

    <!-- ACTIVITY TYPE TOGGLE -->
    <div style="margin-bottom:1.25rem;">
      <div style="font-size:0.72rem; font-weight:600; color:var(--muted); letter-spacing:0.06em; text-transform:uppercase; margin-bottom:0.6rem;">
        Activity Type <span style="color:var(--accent);">*</span>
        <span style="color:var(--muted); font-weight:400; margin-left:0.5rem; font-size:0.65rem;">(select one)</span>
      </div>
      <div style="display:flex; gap:1rem;">
        <label class="activity-toggle" id="lbl-install">
          <input type="radio" name="activity" value="installation" id="chk-install" onchange="switchActivity('installation')">
          <span class="activity-label">
            <span class="activity-icon">⬇</span>
            Installation
          </span>
        </label>
        <label class="activity-toggle" id="lbl-removal">
          <input type="radio" name="activity" value="removal" id="chk-removal" onchange="switchActivity('removal')">
          <span class="activity-label">
            <span class="activity-icon">⬆</span>
            Removal
          </span>
        </label>
      </div>
    </div>

    <!-- Installation Block -->
    <div id="block-install" class="activity-block" style="display:none;">
      <div class="section-label" style="font-size:0.6rem; margin-bottom:0.75rem; color:var(--blue);">⬇ Installation</div>
      <div class="grid-3" style="margin-bottom:1.25rem;">
        <div class="field">
          <label>Installation Date <span class="req">*</span></label>
          <input type="date" id="install-date">
        </div>
        <div class="field">
          <label>Installation Time <span class="req">*</span></label>
          <input type="time" id="install-time" placeholder="HH:MM">
        </div>
        <div class="field">
          <label>Installed By <span class="req">*</span></label>
          <select id="installed-by">
            <option value="">— Select —</option>
            <option>Ksenija</option><option>Dmitrijs</option><option>Antons</option>
            <option>Richard</option><option>Ričards</option><option>Elina</option><option>Andis</option>
            <option>Kristaps</option><option>Fricis</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Removal Block -->
    <div id="block-removal" class="activity-block" style="display:none;">
      <div class="section-label" style="font-size:0.6rem; margin-bottom:0.75rem; color:var(--gold);">⬆ Removal</div>
      <div class="grid-4" style="margin-bottom:1rem;">
        <div class="field">
          <label>Removal Date <span class="req">*</span></label>
          <input type="date" id="removal-date">
        </div>
        <div class="field">
          <label>Removal Time <span class="req">*</span></label>
          <input type="time" id="removal-time">
        </div>
        <div class="field">
          <label>Moisture % After Drying</label>
          <div class="moisture-wrap" id="moisture-after-wrap">
            <input type="number" id="moisture-after" placeholder="e.g. 0.009" step="0.001" min="0"
              oninput="updateMoistureIndicator()">
            <div class="moisture-indicator" id="ind-after"></div>
          </div>
        </div>
        <div class="field">
          <label>Removed By <span class="req">*</span></label>
          <select id="removed-by">
            <option value="">— Select —</option>
            <option>Ksenija</option><option>Dmitrijs</option><option>Antons</option>
            <option>Richard</option><option>Ričards</option><option>Elina</option><option>Andis</option>
            <option>Kristaps</option><option>Fricis</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Calculated preview -->
    <div class="grid-2" id="calc-preview" style="display:none; margin-top:0.5rem;">
      <div class="card" style="margin:0; background:rgba(88,166,255,0.06); border-color:rgba(88,166,255,0.2);">
        <div style="font-size:0.7rem; color:var(--muted); margin-bottom:0.3rem; text-transform:uppercase; letter-spacing:0.1em;">Duration</div>
        <div id="calc-duration" style="font-family:'Space Mono',monospace; font-size:1.3rem; color:var(--blue);">—</div>
      </div>
      <div class="card" style="margin:0; background:rgba(245,166,35,0.06); border-color:rgba(245,166,35,0.2);">
        <div style="font-size:0.7rem; color:var(--muted); margin-bottom:0.3rem; text-transform:uppercase; letter-spacing:0.1em;">Drying Rate</div>
        <div id="calc-rate" style="font-family:'Space Mono',monospace; font-size:1.3rem; color:var(--gold);">—</div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="resetForm()">Clear</button>
      <button class="btn btn-primary" onclick="addEntry()">Add Entry →</button>
    </div>

  </div>

  <!-- LOG TABLE -->
  <div class="divider"></div>
  <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">
    <div class="section-label" style="margin:0; flex:1;">Drying Log — Session Entries</div>
    <button class="btn btn-export" onclick="exportCSV()">⬇ Export CSV</button>
  </div>

  <div class="log-wrap">
    <table id="log-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Batch/Serial</th>
          <th>Material</th>
          <th>cm³</th>
          <th>Before %</th>
          <th>Bay</th>
          <th>Activity</th>
          <th>Install Date</th>
          <th>Install Time</th>
          <th>By</th>
          <th>Removal Date</th>
          <th>Removal Time</th>
          <th>After %</th>
          <th>By</th>
          <th>Duration</th>
          <th>Rate %/hr</th>
        </tr>
      </thead>
      <tbody id="log-body">
        <tr><td colspan="15" class="empty-state">No entries yet. Fill the form above and click <strong>Add Entry</strong>.</td></tr>
      </tbody>
    </table>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// ⚠️ PASTE YOUR WEB APP URL HERE AFTER DEPLOYING THE APPS SCRIPT:
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz20Vs_uCcaitDIw8HVauqqz2UGmp8CA4WMAyDncRPduvh7tZMIUAm7N-fvXIRcZLVSjg/exec';

let entries = JSON.parse(localStorage.getItem('dryerLog') || '[]');
let selectedBay = null;

updateSeqDisplay();
renderTable();

function switchActivity(type) {
  const instBlock = document.getElementById('block-install');
  const remBlock  = document.getElementById('block-removal');
  if (type === 'installation') {
    instBlock.style.display = 'block';
    remBlock.style.display  = 'none';
    // Default install date/time to now
    const now = new Date();
    document.getElementById('install-date').value = now.toISOString().slice(0,10);
    document.getElementById('install-time').value = now.toTimeString().slice(0,5);
  } else {
    instBlock.style.display = 'none';
    remBlock.style.display  = 'block';
    const now = new Date();
    document.getElementById('removal-date').value = now.toISOString().slice(0,10);
    document.getElementById('removal-time').value = now.toTimeString().slice(0,5);
  }
  updateCalcPreview();
}

function selectBay(n) {
  selectedBay = n;
  document.getElementById('bay-hidden').value = n;
  document.querySelectorAll('.bay-btn').forEach((b,i) => {
    b.classList.toggle('active', i+1 === n);
  });
}

function updateMoistureIndicator() {
  const val = parseFloat(document.getElementById('moisture-after').value);
  const ind = document.getElementById('ind-after');
  if (isNaN(val)) { ind.style.background = 'var(--border)'; return; }
  ind.style.background = val <= 0.01 ? 'var(--green)' : 'var(--red)';
}

function updateCalcPreview() {
  const iDate = document.getElementById('install-date').value;
  const iTime = document.getElementById('install-time').value;
  const rDate = document.getElementById('removal-date').value;
  const rTime = document.getElementById('removal-time').value;
  const mBefore = parseFloat(document.getElementById('moisture-before').value);
  const mAfter  = parseFloat(document.getElementById('moisture-after').value);

  if (iDate && iTime && rDate && rTime) {
    const install = new Date(`${iDate}T${iTime}`);
    const removal = new Date(`${rDate}T${rTime}`);
    const diffMs  = removal - install;
    if (diffMs > 0) {
      const totalMins = Math.floor(diffMs / 60000);
      const hrs  = Math.floor(totalMins / 60);
      const mins = totalMins % 60;
      document.getElementById('calc-duration').textContent = 
        `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}`;

      if (!isNaN(mBefore) && !isNaN(mAfter)) {
        const totalHrs = diffMs / 3600000;
        const rate = (mBefore - mAfter) / totalHrs;
        document.getElementById('calc-rate').textContent = rate.toFixed(5) + ' %/h';
      } else {
        document.getElementById('calc-rate').textContent = '—';
      }
      document.getElementById('calc-preview').style.display = 'grid';
      return;
    }
  }
  document.getElementById('calc-preview').style.display = 'none';
}

['install-date','install-time','removal-date','removal-time','moisture-before','moisture-after'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', updateCalcPreview);
});

function updateSeqDisplay() {
  document.getElementById('seq-display').textContent = String(entries.length + 1).padStart(3,'0');
}

function getActivityType() {
  const radios = document.getElementsByName('activity');
  for (const r of radios) if (r.checked) return r.value;
  return null;
}

async function addEntry() {
  const batch    = document.getElementById('batch').value.trim();
  const mat      = document.getElementById('material').value;
  const amount   = document.getElementById('amount').value;
  const mBefore  = document.getElementById('moisture-before').value;
  const bay      = selectedBay;
  const activity = getActivityType();

  if (!batch || !mat || !amount || !mBefore || !bay || !activity) {
    shake(); return;
  }

  let iDate='', iTime='', instBy='', rDate='', rTime='', mAfter='', remBy='';
  let duration='', rate='';

  if (activity === 'installation') {
    iDate  = document.getElementById('install-date').value;
    iTime  = document.getElementById('install-time').value;
    instBy = document.getElementById('installed-by').value;
    if (!iDate || !iTime || !instBy) { shake(); return; }
  } else {
    rDate  = document.getElementById('removal-date').value;
    rTime  = document.getElementById('removal-time').value;
    mAfter = document.getElementById('moisture-after').value;
    remBy  = document.getElementById('removed-by').value;
    if (!rDate || !rTime || !remBy) { shake(); return; }
  }

  // Build payload for Google Sheets
  const payload = {
    activity,
    batch,
    material: mat,
    amount,
    moistureBefore: mBefore,
    bay,
    installDate: iDate,
    installTime: iTime,
    installedBy: instBy,
    removalDate: rDate,
    removalTime: rTime,
    moistureAfter: mAfter,
    removedBy: remBy
  };

  // Disable button while sending
  const btn = document.querySelector('.btn-primary');
  const originalText = btn.textContent;
  btn.textContent = 'Sending…';
  btn.disabled = true;

  try {
    // Apps Script redirects POST → need to follow redirect manually
    // Send as text/plain to avoid CORS preflight
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      redirect: 'follow'
    });
    const result = await resp.json();

    if (!result.success) {
      showToast(result.error || 'Kļūda nosūtot datus!', true);
      btn.textContent = originalText;
      btn.disabled = false;
      return;
    }

    // Success — also save locally
    if (iDate && iTime && rDate && rTime) {
      const install = new Date(`${iDate}T${iTime}`);
      const removal = new Date(`${rDate}T${rTime}`);
      const diffMs  = removal - install;
      if (diffMs > 0) {
        const hrs  = Math.floor(diffMs/3600000);
        const mins = Math.floor((diffMs%3600000)/60000);
        duration = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}`;
        if (mBefore && mAfter) {
          rate = ((parseFloat(mBefore) - parseFloat(mAfter)) / (diffMs/3600000)).toFixed(5);
        }
      }
    }

    entries.push({
      seq: entries.length + 1, batch, mat, amount, mBefore, bay, activity,
      iDate: iDate ? iDate.replace(/-/g,' ') : '', iTime, instBy,
      rDate: rDate ? rDate.replace(/-/g,' ') : '', rTime, mAfter, remBy,
      duration, rate
    });

    localStorage.setItem('dryerLog', JSON.stringify(entries));
    updateSeqDisplay();
    renderTable();
    resetForm();
    showToast(result.message || '✓ Ieraksts pievienots Google Sheets!');

  } catch (err) {
    showToast('Tīkla kļūda: ' + err.message, true);
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

function renderTable() {
  const tbody = document.getElementById('log-body');
  if (!entries.length) {
    tbody.innerHTML = '<tr><td colspan="16" class="empty-state">No entries yet. Fill the form above and click <strong>Add Entry</strong>.</td></tr>';
    return;
  }
  tbody.innerHTML = entries.map(e => {
    const afClass = e.mAfter !== '' ? (parseFloat(e.mAfter) <= 0.01 ? 'td-green' : 'td-red') : '';
    const actBadge = e.activity === 'installation'
      ? '<span style="color:var(--blue);font-size:0.7rem;font-weight:700;">⬇ INSTALL</span>'
      : '<span style="color:var(--gold);font-size:0.7rem;font-weight:700;">⬆ REMOVAL</span>';
    return `<tr>
      <td class="td-seq">${String(e.seq).padStart(3,'0')}</td>
      <td>${e.batch}</td>
      <td>${e.mat}</td>
      <td>${e.amount}</td>
      <td>${e.mBefore}</td>
      <td style="text-align:center;font-family:'Space Mono',monospace;font-weight:700;color:var(--gold)">${e.bay}</td>
      <td>${actBadge}</td>
      <td>${e.iDate}</td>
      <td>${e.iTime}</td>
      <td>${e.instBy}</td>
      <td>${e.rDate}</td>
      <td>${e.rTime}</td>
      <td class="${afClass}">${e.mAfter}</td>
      <td>${e.remBy}</td>
      <td class="td-calc">${e.duration}</td>
      <td class="td-calc">${e.rate}</td>
    </tr>`;
  }).join('');
}

function resetForm() {
  ['batch','amount','moisture-before','moisture-after','removal-date','removal-time',
   'install-date','install-time'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('material').value = '';
  document.getElementById('installed-by').value = '';
  document.getElementById('removed-by').value = '';
  selectedBay = null;
  document.querySelectorAll('.bay-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('bay-hidden').value = '';
  document.getElementById('ind-after').style.background = 'var(--border)';
  document.getElementById('calc-preview').style.display = 'none';
  document.querySelectorAll('input[name="activity"]').forEach(r => r.checked = false);
  document.getElementById('block-install').style.display = 'none';
  document.getElementById('block-removal').style.display = 'none';
}

function showToast(msg, isError) {
  const t = document.getElementById('toast');
  t.textContent = isError ? '✗ ' + msg : '✓ ' + msg;
  t.style.borderColor = isError ? 'var(--red)' : 'var(--green)';
  t.style.color = isError ? 'var(--red)' : 'var(--green)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), isError ? 5000 : 2800);
}

function shake() {
  const card = document.querySelector('.card-accent');
  card.style.animation = 'none';
  card.offsetHeight;
  card.style.animation = 'shake 0.4s ease';
  setTimeout(() => card.style.animation = '', 400);
}

function exportCSV() {
  if (!entries.length) return;
  const cols = ['Seq','Batch/Serial','Material','cm³','Moisture Before %','Bay','Activity',
    'Install Date','Install Time','Installed By','Removal Date','Removal Time',
    'Moisture After %','Removed By','Duration','Rate %/hr'];
  const rows = entries.map(e => [
    e.seq, e.batch, e.mat, e.amount, e.mBefore, e.bay, e.activity||'',
    e.iDate, e.iTime, e.instBy, e.rDate, e.rTime, e.mAfter, e.remBy,
    e.duration, e.rate
  ].map(v => `"${v}"`).join(','));
  const csv = [cols.join(','), ...rows].join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `Polymer_Dryer_Log_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}
</script>

<style>
@keyframes shake {
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-6px)}
  40%{transform:translateX(6px)}
  60%{transform:translateX(-4px)}
  80%{transform:translateX(4px)}
}
</style>
</body>
</html>
